<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ Ã‰crituria v2.1 - Assistant Fiction RAG</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>âœ¨ Ã‰crituria</h1>
                <span>v2.1 - Assistant Fiction RAG</span>
            </div>

            <div class="project-select">
                <select id="projectSelect" onchange="loadProject()">
                    <option value="anomalie2084">ğŸ“– Anomalie 2084</option>
                </select>
            </div>

            <div class="file-tree" id="fileTree">
                <div class="empty-state">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">Chargement...</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="toolbar">
                <h2 id="pageTitle">Bienvenue sur Ã‰crituria v2.1</h2>
                <div class="highlight-box">
                    <input id="highlightInput" class="highlight-input" type="text" placeholder="Surligner..." />
                    <button class="toolbar-btn" onclick="highlightText()">ğŸ¯ Surligner</button>
                    <button class="toolbar-btn" onclick="resetHighlight()">â†º RÃ©initialiser</button>
                </div>
                <button class="toolbar-btn" onclick="showStats()">ğŸ“Š Stats</button>
                <button class="toolbar-btn" onclick="populateGraph()">ğŸ”— Peupler Graphe</button>

                <!-- Actions fichier -->
                <div class="file-actions" id="fileActions" style="display:none;">
                    <span class="separator">|</span>
                    <button class="toolbar-btn edit-btn" onclick="toggleEditMode()" id="editBtn">âœï¸ Ã‰diter</button>
                    <button class="toolbar-btn" onclick="duplicateFile()">ğŸ“‹ Dupliquer</button>
                    <button class="toolbar-btn" onclick="renameFile()">âœï¸ Renommer</button>
                    <button class="toolbar-btn danger-btn" onclick="deleteFile()">ğŸ—‘ï¸ Supprimer</button>
                </div>

                <!-- Nouveau: Upload + Index -->
                <div class="upload-actions" style="margin-left:auto; display:flex; gap:8px;">
                    <button class="toolbar-btn config-btn" onclick="openConfigModal()" title="Configuration">âš™ï¸
                        Configuration</button>
                    <button class="toolbar-btn upload-btn" onclick="openUploadModal()">ğŸ“¤ Upload</button>
                    <button class="toolbar-btn index-btn" onclick="triggerReindex()">ğŸ”„ RÃ©indexer</button>
                    <button class="toolbar-btn success-btn" onclick="createNewFile()">â• Nouveau fichier</button>
                </div>
            </div>

            <div class="content-area">
                <!-- Mode lecture -->
                <div id="fileContent" class="file-viewer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“š</div>
                        <h3>SÃ©lectionnez un fichier</h3>
                        <p>Choisissez un fichier dans la barre latÃ©rale pour afficher son contenu</p>
                        <p style="margin-top: 20px; font-size: 14px; color: var(--text-muted);">
                            <strong>NouveautÃ©s v2.1:</strong><br>
                            ğŸ“¤ Upload de fichiers (PDF, DOCX, MD, TXT)<br>
                            ğŸ”„ RÃ©indexation depuis l'interface<br>
                            ğŸ” Recherche hybride BM25 + vecteurs<br>
                            ğŸ”— Graphe de connaissances (GraphRAG)
                        </p>
                    </div>
                </div>

                <!-- Mode Ã©dition -->
                <div id="editMode" class="edit-mode" style="display:none;">
                    <textarea id="editTextarea" class="edit-textarea" placeholder="Contenu du fichier..."></textarea>
                    <div class="edit-toolbar">
                        <button class="save-btn" onclick="saveFile()">ğŸ’¾ Sauvegarder</button>
                        <button class="cancel-btn" onclick="cancelEdit()">âŒ Annuler</button>
                        <span class="edit-hint">Ctrl+S pour sauvegarder</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <h3>ğŸ’¬ Chat IA</h3>
                <div class="chat-options">
                    <select id="modelSelect" class="model-select"></select>
                    <label
                        title="Active le graphe de connaissances (extraction d'entitÃ©s, contextes reliÃ©s) en plus du RAG vectoriel">
                        <input type="checkbox" id="useGraph"> GraphRAG
                    </label>
                    <label
                        title="Orchestrateur multi-agents (Rechercheur, Coherence, Creatif) pour des rÃ©ponses chaÃ®nÃ©es et spÃ©cialisÃ©es">
                        <input type="checkbox" id="useAgents"> Agents
                    </label>
                </div>
                <div class="chat-help">
                    GraphRAG = graphe + RAG vectoriel. Agents = orchestration (Rechercheur, Coherence, Creatif).
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message">
                    <div class="message-assistant">
                        <div class="message-label">âœ¨ Ã‰CRITURIA v2.1</div>
                        Bienvenue! Je suis votre assistant d'Ã©criture augmentÃ©.<br><br>
                        <strong>NouveautÃ©s:</strong><br>
                        â€¢ ğŸ“¤ <em>Upload</em> de fichiers directement dans l'interface<br>
                        â€¢ ğŸ”„ <em>RÃ©indexation</em> en un clic<br>
                        â€¢ Cochez <em>GraphRAG</em> pour utiliser le graphe de connaissances<br>
                        â€¢ Cochez <em>Agents</em> pour des rÃ©ponses multi-agents
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input">
                    <textarea id="chatInput" rows="3" placeholder="Posez votre question..."></textarea>
                    <button id="sendButton" class="btn-send" onclick="sendMessage()">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal" style="display:none;">
        <div class="modal-content upload-modal-content">
            <div class="modal-header">
                <h3>ğŸ“¤ Upload de fichiers</h3>
                <button class="close-btn" onclick="closeUploadModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">ğŸ“</div>
                    <p>Glissez-dÃ©posez vos fichiers ici</p>
                    <p class="upload-hint">ou cliquez pour sÃ©lectionner</p>
                    <input type="file" id="fileInput" multiple accept=".md,.txt,.pdf,.docx,.doc" style="display:none;">
                    <p class="upload-formats">Formats: MD, TXT, PDF, DOCX</p>
                </div>
                <div class="upload-options">
                    <label>Dossier cible:</label>
                    <select id="uploadFolder">
                        <option value="lore">ğŸ“š lore</option>
                        <option value="personnages">ğŸ‘¤ personnages</option>
                        <option value="chapitres">ğŸ“– chapitres</option>
                        <option value="intrigue">ğŸ­ intrigue</option>
                        <option value="notes">ğŸ“ notes</option>
                    </select>
                </div>
                <div id="uploadProgress" class="upload-progress" style="display:none;">
                    <div class="progress-text">Upload en cours...</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>
                <div id="uploadResults" class="upload-results"></div>
            </div>
            <div class="modal-footer">
                <label class="auto-index-label">
                    <input type="checkbox" id="autoReindex" checked> RÃ©indexer aprÃ¨s upload
                </label>
                <button class="modal-btn cancel" onclick="closeUploadModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="modal" style="display:none;">
        <div class="modal-content config-modal-content">
            <div class="modal-header">
                <h3>âš™ï¸ Configuration</h3>
                <button class="close-btn" onclick="closeConfigModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h4>ğŸ”‘ ClÃ© API OpenRouter</h4>
                    <p class="config-description">
                        Configurez votre clÃ© API OpenRouter pour utiliser diffÃ©rents modÃ¨les d'IA.
                        La clÃ© est stockÃ©e dans le fichier <code>.env</code>.
                    </p>

                    <div class="api-key-display">
                        <label>ClÃ© actuelle:</label>
                        <div class="api-key-value">
                            <input type="password" id="currentApiKey" readonly value="************">
                            <button class="toggle-visibility-btn" onclick="toggleApiKeyVisibility()"
                                title="Afficher/Masquer">
                                ğŸ‘ï¸
                            </button>
                        </div>
                    </div>

                    <div class="api-key-edit" style="margin-top: 20px;">
                        <label>Nouvelle clÃ© API:</label>
                        <input type="text" id="newApiKey" class="api-key-input" placeholder="sk-or-v1-...">
                        <button class="save-api-key-btn" onclick="saveApiKey()">ğŸ’¾ Enregistrer</button>
                    </div>

                    <div class="config-hint">
                        ğŸ’¡ Vous pouvez obtenir votre clÃ© API sur <a href="https://openrouter.ai/keys"
                            target="_blank">openrouter.ai/keys</a>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel" onclick="closeConfigModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Global Status -->
    <div id="globalStatus" class="status hidden">
        <div class="dot"></div>
        <div class="msg">PrÃªt</div>
        <div class="progress-wrap">
            <div class="progress-bar" id="statusProgress"></div>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>

</html>